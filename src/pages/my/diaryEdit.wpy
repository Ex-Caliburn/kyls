<style>
.weui-textarea{
  min-height: 450rpx;
}
.icon-cancel{
  position: absolute;
  top: -2rpx;
  right: -5rpx;
}
.weui-uploader__file{
  position: relative;
}
</style>

<template>
  <view class="page">
    <view class="page__bd">
      <view class="weui-cells__title fz26">{{time}}</view>
      <view class="weui-cells weui-cells_after-title">
        <view class="weui-cell weui-cell_input">
          <view class="weui-cell__bd">
            <input class="weui-input" @change="titleBind" placeholder="请输入日记标题" value="{{title}}"/>
          </view>
        </view>
        <view class="weui-cell">
          <view class="weui-cell__bd">
            <textarea @input="contentBind" class="weui-textarea" maxlength="-1" placeholder="请输入日记内容" value="{{content}}"/>
            <view class="weui-textarea-counter">{{content.length}}</view>
          </view>
        </view>

        <uploadPic :files.sync="pictures"></uploadPic>
      </view>
    </view>
  </view>
  <button @tap="submit" class="weui-btn mini-btn type_yellow fz26">{{diaryId ? '修改' : '增添'}}日记</button>
  <tabbar :tabbar.sync='tabbar'></tabbar>
</template>


<script>
  import wepy from 'wepy'
  import Tabbar from '@/components/tabbar'
  import uploadPic from '@/components/uploadPic'
  import Toast from 'wepy-com-toast'
  import tabbar from 'mixins/tabbar'
  import navigate from 'mixins/navigate'
  import { post } from 'utils/service'
  import { formatDate } from 'utils/common'

  export default class diaryEdit extends wepy.page {
    config = {
      navigationBarTitleText: '我的考研日记'
    }
    components = {
      tabbar: Tabbar,
      uploadPic: uploadPic,
      toast: Toast
    }

    mixins = [tabbar, navigate]

    data = {
      pictures: [],
      createdAt: formatDate(new Date()),
      diaryId: 0,
      title: '',
      content: ''
    }

    computed = {
      txtLength () {
        return this.content.length
      }
    }
    methods = {
      titleBind (e) {
        this.title = e.detail.value
      },
      contentBind (e) {
        this.content = e.detail.value
      },
      questionInput (e) {
        this.content = e.detail.value
      },
      submit () {
        let {content, pictures, title, diaryId} = this
        let apiName = diaryId ? 'editDiary' : 'addDiary'
        post({
          apiName,
          data: {
            diaryId,
            title,
            content,
            pictures: pictures.join(',')
          }
        }).then((res) => {
          this.$parent.globalData.diaryEdit = ''
          this.navigate('my/diary', 1)
        }).catch(err => {
          console.log(err)
        })
      }
    }

    onShow () {
    }

    onLoad (params) {
      console.log(params.diaryId)
      this.diaryId = params.diaryId
      if (params.diaryId) {
        this.title = ''
        this.content = ''
        this.createdAt = ''
      }
      let diaryEdit = this.$parent.globalData.diaryEdit
      if (diaryEdit) {
        if (diaryEdit.diaryPictures) {
          this.pictures = diaryEdit.diaryPictures.split(',')
        }
        this.title = diaryEdit.title
        this.content = diaryEdit.content
        this.time = formatDate(new Date(diaryEdit.createdAt))
      }
      this.$apply()
    }
  }
</script>
